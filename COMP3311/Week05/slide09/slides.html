<html>
<head>
<title>COMP3311 Week 5 Tuesday Lecture</title>
<link href='lib/slides.css' rel='stylesheet' type='text/css'>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML" async></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
<link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet'>
<link href='lib/prism.css' rel='stylesheet'>
<script src='lib/sg.js'></script>
</head>
<body>
 <DIV class='slideCl1' id="s0"  >
<div class='navCl1'><a href="#s1"><span class='nextArrowCl'>>></span></a> </div> <div class='heading'>COMP3311 Week 5 Tuesday Lecture</div><p><ul class='indexUl'  style='font-size: 0.7em;'><li class="i"> <a href="#s1">Week 05 Tuesday</heading></a>
<li class="i"> <a href="#s2"> Submitting/Marking Assignment 1</a>
<li class="i"> <a href="#s4">Assignment Hints</a>
<li class="i"> <a href="#s6">Developing Complex SQL Queries</a>
<li class="i"> <a href="#s7">Developing PLpgSQL Functions</a>
<li class="i"> <a href="#s8">Iteration in PLpgSQL</a>
<li class="i"> <a href="#s10">Exercise: Poor use of loop</a>
<li class="i"> <a href="#s11">Dynamic Queries</a>
<li class="i"> <a href="#s12">Exercise: Dynamic Queries</a>
<li class="i"> <a href="#s13">Exceptions</a>
<li class="i"> <a href="#s14">Exercise: Exceptions</a>
<li class="i"> <a href="#s15">Aggregates</a>
<li class="i"> <a href="#s17">Exercise: User-defined Aggregates</a>
<li class="i"> <a href="#s18">Global Constraints</a>
<li class="i"> <a href="#s20">Triggers</a>
<li class="i"> <a href="#s22">Triggers in PostgreSQL</a>
<li class="i"> <a href="#s23">Exercise: Trigger Example (i)</a>
<li class="i"> <a href="#s24">Exercise: Trigger Example (ii)</a>
<li class="i"> <a href="#s25">Programming with Databases</a>
</ul></DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [0/31]</div> <DIV class='slideCl1    ' id="s1"  >
<div class='navCl1'> <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s2"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Week 05 Tuesday</heading></div></td><td align='right'></td></tr></table>
<p>
<h4>In this week's lectures ...</h4>
<ul>
<li> PLpgSQL, Aggregates, Triggers, DBMS&harr;PL
</ul>
<h4>Things to do ...</h4>
<ul>
<li> Assignment 1 due before Friday <font color="#CC0000">11:59pm</font> <br>
	<span class="smaller">(60 submissions so far; 500 more to go)</span>
<li> Set up your PostgreSQL server <br>
	<span class="smaller">(550 students have /localstorage, X have PostgreSQL servers)</span>
<li> Check your assignment on &nbsp;<large><code>vxdb2</code></large>&nbsp; before submitting
</ul>
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [1/31]</div> <DIV class='slideCl1    ' id="s2"  >
<div class='navCl1'><a href="#s1"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s3"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070;  Submitting/Marking Assignment 1</div></td><td align='right'></td></tr></table>
<p>
<br>
Test on &nbsp;<large><code>vxdb2</code></large> before submitting
<p>
Submit via: &nbsp;<large><code>give cs3311 ass1 ass1.sql</code></large>
<p>
Will be tested via:
<p><pre>
dropdb ass1;  createdb ass1;  psql ass1 -f ass1.dump
psql ass1 -f ass1.sql <span class='comment'># your submission</span>
3311 autotest ass1
dropdb ass1;  createdb ass1;  psql ass1 -f <font color="#000099">ass1a.dump</font>
psql ass1 -f ass1.sql <span class='comment'># your submission</span>
3311 autotest ass1
</pre><p>
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [2/31]</div> <DIV class='slideCl1    ' id="s3"  >
<div class='navCl1'><a href="#s2"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s4"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070;  Submitting/Marking Assignment 1 <span style="font-size:67%">(cont)</span></div></td><td align='right'></td></tr></table>
<p>
<br>
Tutors will look at: &nbsp;<large><code>ass1.sql</code></large>, output from two test runs
<p>
Up to 1 mark for style; ugly code gets 0
<p>
Consistency of style is important; &nbsp; use SQL from lectures as guide
<p>
If view fails auto-test
<ul>
<li> can still get <i>some</i> marks for that question 
<li> depending on how close it is to correct answer
<li> no marks if the style is bad and too hard to read
</ul>
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [3/31]</div> <DIV class='slideCl1    ' id="s4"  >
<div class='navCl1'><a href="#s3"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s5"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Assignment Hints</div></td><td align='right'></td></tr></table>
<p>
<br>
Some ideas ...
<ul>
<li> hints: &nbsp;<large><code>case..when</code></large>, &nbsp;&nbsp;&nbsp;<large><code>regexp_replace()</code></large>, &nbsp;&nbsp;&nbsp;<large><code>string_agg()</code></large>
<li> look up things in PostgreSQL documentation for more detail
<li> write helper views that are useful in several questions
<li> run extra queries to verify parts of your query or helper views
<li> use &nbsp;<large><code>raise notice</code></large>&nbsp; for debugging PLpgSQL functions
</ul>
"Unseen" database for auto-marking has same schema, different data
<ul>
<li> aims to check whether your solutions work in the general case
</ul>
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [4/31]</div> <DIV class='slideCl1    ' id="s5"  >
<div class='navCl1'><a href="#s4"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s6"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Assignment Hints <span style="font-size:67%">(cont)</span></div></td><td align='right'></td></tr></table>
<p>
If you get this error ...
<p><pre>
nw-syd-vxdb2 % <b>psql ass1 -f ass1.sql</b>
psql: error: ass1.sql: No such file or directory
</pre><p>
you're in the wrong directory.
<p>
Try <large><code>cd</code></large> until <large><code>ls</code></large> shows <large><code>ass1.sql</code></large>
<p>
If you get this error ...
<p><pre>
ass1=#
ERROR: already defined V
</pre><p>
change <large><code>create view</code></large> to <large><code>create or replace view</code></large>
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [5/31]</div> <DIV class='slideCl1    ' id="s6"  >
<div class='navCl1'><a href="#s5"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s7"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Developing Complex SQL Queries</div></td><td align='right'></td></tr></table>
<p>
Work backwards from the final query
<ul>
<li> if I had a table like R, the final query would be easy <br>
	<span class="smaller">(e.g. could use a pattern like &nbsp;<large><code>select x from R where y = (select min(y) from R)</code></large>)</span>
<li> write a view to produce R
<li> if I had table S, producing R would be easy
<li> write a view to produce S
<li> etc. etc.
</ul>
Try to minmise the complexity of individual views
<p>
Use attribute names in the &nbsp;<large><code>create or replace view</code></large>&nbsp; statement <br>
 <span class="smaller">(easier to keep track of what results the view is producing for use in other views)</span>
<p>
Cannot change number/types of view attributes without dropping view
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [6/31]</div> <DIV class='slideCl1    ' id="s7"  >
<div class='navCl1'><a href="#s6"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s8"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Developing PLpgSQL Functions</div></td><td align='right'></td></tr></table>
<p>
Determine function signature
<ul>
<li> what args are passed in, what result(s) returned
</ul>
For function producing a single result
<ul>
<li> develop a query to extract the data you need
<li> combine the data to produce result value/tuple
</ul>
For function producing a set of results
<ul>
<li> develop a query to extract useful data
<li> iterate through tuples &nbsp; <span class="smaller">(<large><code>for <i>Rec</i> in <i>Query</i> loop ...</code></large>)</span>
<li> incrementally build the result set
</ul>
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [7/31]</div> <DIV class='slideCl1    ' id="s8"  >
<div class='navCl1'><a href="#s7"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s9"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Iteration in PLpgSQL</div></td><td align='right'></td></tr></table>
<p>
<br>
Use SQL queries within function do as much work as possible
<p>
Don't do using code what you could do using
<ul>
<li> <large><code>where</code></large> clause ... avoids tests within loops
<p><pre style="font-size:90%">
for each tuple T in Table {        <i>replace Table by</i>
   if Cond(T) then ...             select * from Table
}                                  where Cond
</pre><p>
<li> <large><code>join</code></large> operation ... avoids nested loops
<p><pre style="font-size:90%">
for each tuple T in T1 {            <i>replace by</i>
   for each tuple S in T2 {         select *
      if T.x = S.y then ...         from T1 join T2 on x=y
}  }
</pre><p>
</ul>
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [8/31]</div> <DIV class='slideCl1    ' id="s9"  >
<div class='navCl1'><a href="#s8"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s10"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Iteration in PLpgSQL <span style="font-size:67%">(cont)</span></div></td><td align='right'></td></tr></table>
<p>
Example: function returning &nbsp; <large><code>setof Beers</code></large>
<p><pre style="font-size:80%">
create or replace function bb(_patt text) returns setof Beers
as $$
declare
   b Beers;
begin
   for b in select * from Beers
   loop
      if b.name ~ _name then
         return next b;
      end if
   end loop;
end;
$$ language plpgsql;
</pre><p>
vs
<p><pre style="font-size:80%">
create or replace function bb(_patt text) returns setof Beers
as $$
declare
   b Beers;
begin
   for b in select * from Beers where name ~ _name
   loop
      return next b;
   end loop;
end;
$$ language plpgsql;
</pre><p>
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [9/31]</div> <DIV class='slideCl1    ' id="s10"  >
<div class='navCl1'><a href="#s9"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s11"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Exercise: Poor use of loop</div></td><td align='right'></td></tr></table>
<p>
Which of the following is the preferred way of filtering
<p><pre>
   for rec in
      select * from R
   loop
      if (rec.a = 5) then
         ...
      end if;
   end loop;
<font color="#0000EE">OR</font>
   for rec in
      select * from R where a = 5
   loop
      ...
   end loop;
</pre><p>
Why? &nbsp;&nbsp; Assume: &nbsp;|R| = 1000 tuples, &nbsp;10 tuples with &nbsp;<large><code>a=5</code></large>
<p>
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [10/31]</div> <DIV class='slideCl1    ' id="s11"  >
<div class='navCl1'><a href="#s10"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s12"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Dynamic Queries</div></td><td align='right'></td></tr></table>
<p>
<br>
Queries can be "built" as strings of SQL code within functions
<p>
And then evaluated using &nbsp;<large><font color="#008800"><b><code>execute</code></b></font></large>&nbsp; <i>Query</i>
<p>
Including constant and identifiers in queries needs
<ul>
<li> <large><font color="#008800"><b><code>quote_literal</code></b></font></large> ... ensure that constants are appropriately quoted
<li> <large><font color="#008800"><b><code>quote_ident</code></b></font></large> ... ensure that identifiers are quoted, if needed
</ul>
<p>
Use &nbsp;<large><code>execute <i>Query</i> into <i>Var</i></code></large>&nbsp;&nbsp; to capture result 
<p>
Can also use in &nbsp;<large><code>for <i>Rec</i> in execute <i>Query</i> loop ...</code></large>
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [11/31]</div> <DIV class='slideCl1    ' id="s12"  >
<div class='navCl1'><a href="#s11"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s13"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Exercise: Dynamic Queries</div></td><td align='right'></td></tr></table>
<p>
Write a PLpgSQL function
<p><pre>
create or replce function
   nTuples(tableName text) return integer
as $$ ...
</pre><p>
The function
<ul>
<li> takes the name of a table as an argument
<li> returns the number of tuples in that table
</ul>
<br>
See the &nbsp;<large><code>dbPop()</code></large>&nbsp; function for an extension of this idea.
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [12/31]</div> <DIV class='slideCl1    ' id="s13"  >
<div class='navCl1'><a href="#s12"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s14"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Exceptions</div></td><td align='right'></td></tr></table>
<p>
Exceptional conditions can arise during function execution
<p>
PLpgSQL provides mechanisms
<ul>
<li> to catch exceptional conditions
<li> to handle caught exceptions
</ul>
Syntax:
<p><pre>
begin
   ... some code ...
exception
   <large><font color="#008800"><b><code>when</code></b></font></large> <i>exceptionName</i> <font color="#008800">then</font>
      ... code to handle exception ...
end;
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [13/31]</div> <DIV class='slideCl1    ' id="s14"  >
<div class='navCl1'><a href="#s13"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s15"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Exercise: Exceptions</div></td><td align='right'></td></tr></table>
<p>
<br>
Implement a "safe" division function
<p><pre>
create or replace function
   div(n integer, m integer) returns integer
</pre><p>
<ul>
<li> returns n/m if m is non-zero
<li> returns null if m is zero
</ul>
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [14/31]</div> <DIV class='slideCl1    ' id="s15"  >
<div class='navCl1'><a href="#s14"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s16"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Aggregates</div></td><td align='right'></td></tr></table>
<p>
Aggregates reduce a collection of values to a single value
<p>
Example:
<p><pre style="font-size:90%">
select avg(mark) from Enrolments where course='COMP3311'
</pre><p>
<p>
How to achieve this? ... Maintain state, update value-by-value
<p><pre>
State = initial state
for each tuple T in query {
    <span class='comment'># update State to include T</span>
    State = updateState(State, T)
}
return makeFinal(State)
</pre><p>
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [15/31]</div> <DIV class='slideCl1    ' id="s16"  >
<div class='navCl1'><a href="#s15"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s17"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Aggregates <span style="font-size:67%">(cont)</span></div></td><td align='right'></td></tr></table>
<p>
<br>
New aggregates are defined using <large><font color="#008800"><b><code>CREATE AGGREGATE</code></b></font></large> statement:
<p><pre>
<font color="#008800">CREATE AGGREGATE</font> AggName(BaseType<font color="#008800">) (</font>
    <font color="#008800">stype     =</font> StateType,
    <font color="#008800">initcond  =</font> InitialValue,
    <font color="#008800">sfunc     =</font> UpdateStateFunction,
    <font color="#008800">finalfunc =</font> MakeFinalFunction
);
</pre><p>
<ul>
<li> <large><code>initcond</code></large> (type StateType) is optional; defaults to NULL
<li> <large><code>finalfunc</code></large> is optional; defaults to identity function
</ul>
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [16/31]</div> <DIV class='slideCl1    ' id="s17"  >
<div class='navCl1'><a href="#s16"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s18"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Exercise: User-defined Aggregates</div></td><td align='right'></td></tr></table>
<p>
<ol>
<li> make a <large><code>product</code></large> aggregate
<p><pre>
select product(a) from R  &rarr;  6
</pre><p>
<li> simple string concatentation (comma-separated)
<p><pre>
select cat(b) from R  &rarr;  'this,is,fun'
</pre><p>
<li> make your own <large><code>count</code></large> aggregate
<p><pre>
select mycount(a) from R  &rarr;  3
select mycount(b) from R  &rarr;  3
</pre><p>
</ol>
Assuming
<p><pre style="font-size:90%">
create table R (a integer, b text);
insert into R values (1,'this'), (2,'is'), (3,'fun');
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [17/31]</div> <DIV class='slideCl1    ' id="s18"  >
<div class='navCl1'><a href="#s17"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s19"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Global Constraints</div></td><td align='right'></td></tr></table>
<p>
Column and table constraints ensure validity of one table
<p>
Ref. integrity constraints ensure connections between tables are valid
<p>
Global constraints may involve conditions over many tables
<p>
Simple example (from banking domain):
<p><pre>
<span class='comment'>-- accounts are held at branches</span>
<span class='comment'>-- assets of branch is sum of balances of its accounts</span>

for all Branches b
   b.assets == (select sum(acct.balance)
                from   Accounts acct
                where  acct.branch = b.location)
</pre><p>
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [18/31]</div> <DIV class='slideCl1    ' id="s19"  >
<div class='navCl1'><a href="#s18"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s20"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Global Constraints <span style="font-size:67%">(cont)</span></div></td><td align='right'></td></tr></table>
<p>
SQL implementation of global constraints is <large><font color="#008800"><b><code>ASSERTION</code></b></font></large>
<p>
Example: #students in any UNSW course must be < 10000
<p><pre>
create assertion ClassSizeConstraint check (
   not exists (
      select c.id
      from   Courses c
             join Enrolments e on (c.id = e.course)
      group  by c.id
      having count(e.student) > 9999
   )
);
</pre><p>
Must be checked after every change to either <large><code>Courses</code></large> or <large><code>Enrolments</code></large>
<p>
Too expensive, so DBMSs provide <font color='#0000BB'>triggers</font> to do targetted checking.
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [19/31]</div> <DIV class='slideCl1    ' id="s20"  >
<div class='navCl1'><a href="#s19"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s21"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Triggers</div></td><td align='right'></td></tr></table>
<p>
<br>
<font color='#0000BB'>Triggers</font> are
<ul>
<li> procedures stored in the database
<li> activated in response to database events &nbsp; <span class="smaller">(e.g. insert/update/delete)
</ul>
Examples of uses for triggers:
<ul>
<li> maintaining summary data
<li> checking schema-level constraints (assertions) on update
<li> performing multi-table updates (to maintain assertions)
</ul>
Triggers provide event-condition-action programming
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [20/31]</div> <DIV class='slideCl1    ' id="s21"  >
<div class='navCl1'><a href="#s20"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s22"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Triggers <span style="font-size:67%">(cont)</span></div></td><td align='right'></td></tr></table>
<p>
<br>
Sequence of activities during database update:
<p>
<p><div align='center'>
<img alt="[Diagram:Pics/dbms/trigger-seq.png]" src="Pics/dbms/trigger-seq.png">
</div><p>
<p><br>
Reminder: <large><code>BEFORE</code></large> and <large><code>UPDATE</code></large> triggers can modify value of new tuple
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [21/31]</div> <DIV class='slideCl1    ' id="s22"  >
<div class='navCl1'><a href="#s21"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s23"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Triggers in PostgreSQL</div></td><td align='right'></td></tr></table>
<p>
PostgreSQL triggers provide a mechanism for
<ul>
<li> <large><code>INSERT</code></large>, <large><code>DELETE</code></large> or <large><code>UPDATE</code></large> events
<li> to automatically activate PLpgSQL functions
</ul>
Syntax for PostgreSQL trigger definition:
<p><pre>
<large><font color="#008800"><b><code>CREATE TRIGGER</code></b></font></large> <i>TriggerName</i>
{<large><font color="#008800"><b><code>AFTER</code></b></font></large>|<large><font color="#008800"><b><code>BEFORE</code></b></font></large>}  <i>Event1</i> [<large><font color="#008800"><b><code>OR</code></b></font></large> <i>Event2</i> ...]
<large><font color="#008800"><b><code>ON</code></b></font></large> <i>TableName</i>
[ <large><font color="#008800"><b><code>WHEN</code></b></font></large> ( <i>Condition</i> ) ]
<large><font color="#008800"><b><code>FOR EACH</code></b></font></large> {ROW|STATEMENT}
<large><font color="#008800"><b><code>EXECUTE PROCEDURE</code></b></font></large> <i>FunctionName</i>(<i>args...</i>);
</pre><p>
<ul>
<li> <large><code>BEFORE</code></large> triggers must return <large><code>old</code></large> or <large><code>new</code></large>
<li> any exception during a trigger forces roll-back
</ul>
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [22/31]</div> <DIV class='slideCl1    ' id="s23"  >
<div class='navCl1'><a href="#s22"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s24"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Exercise: Trigger Example (i)</div></td><td align='right'></td></tr></table>
<p>
<br>
Consider two tables
<p><pre style="font-size:90%">
create table R (id integer, val text);
create table S (r integer references R(id), value text);
</pre><p>
Write a trigger to check that the foreign key value is valid
<ul>
<li> when you insert a new <large><code>S</code></large> tuple
<li> when you update an existing <large><code>S</code></large> tuple
</ul>
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [23/31]</div> <DIV class='slideCl1    ' id="s24"  >
<div class='navCl1'><a href="#s23"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s25"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Exercise: Trigger Example (ii)</div></td><td align='right'></td></tr></table>
<p>
<br>
Class enrolments:
<p><pre>
Classes(id,name,room,day,start,end,quota,nstu)
ClassEnrolments(student,class)
</pre><p>
Define triggers to maintain <large><code>nstu</code></large> for
<p><pre>
insert into ClassEnrolments values (5012345, 6732);

insert into ClassEnrolments values (9999999, 99999);

delete from ClassEnrolments
where  student = 5012345 and class = 6732;
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [24/31]</div> <DIV class='slideCl1    ' id="s25"  >
<div class='navCl1'><a href="#s24"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s26"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Programming with Databases</div></td><td align='right'></td></tr></table>
<p>
So far, we have seen ...
<ul>
<li> accessing data via SQL queries
<li> packaging SQL queries as views/functions
<li> building functions to return tables
<li> implementing assertions via triggers
</ul>
All of the above programming
<ul>
<li> is very close to the data
<li> takes place inside the DBMS
</ul>
For applications need a PL interacting with the DBMS.
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [25/31]</div> <DIV class='slideCl1    ' id="s26"  >
<div class='navCl1'><a href="#s25"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s27"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Programming with Databases <span style="font-size:67%">(cont)</span></div></td><td align='right'></td></tr></table>
<p>
Programming Language / DBMS archtecture:
<br>
<p><div align='center'>
<img alt="[Diagram:Pics/pldb/dbpl-arch.png]" src="Pics/pldb/dbpl-arch.png">
</div><p>
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [26/31]</div> <DIV class='slideCl1    ' id="s27"  >
<div class='navCl1'><a href="#s26"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s28"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Programming with Databases <span style="font-size:67%">(cont)</span></div></td><td align='right'></td></tr></table>
<p>
Consider this (imaginary) PL/DBMS access method:
<p><pre>
<span class='comment'>--  establish connection to DBMS</span>
db = dbAccess("DB");
query = "select a,b from R,S where ... ";
<span class='comment'>--  invoke query and get handle to result set</span>
results = dbQuery(db, query);
<span class='comment'>--  for each tuple in result set</span>
while (tuple = dbNext(results)) {
    <span class='comment'>--  process next tuple</span>
    process(tuple['a'], tuple['b']);
}
</pre><p>
<br>
Estimated costs: &nbsp;<large><code>dbAccess</code></large> = 500ms, &nbsp;<large><code>dbQuery</code></large> = 200ms, &nbsp;<large><code>dbNext</code></large> < 1ms
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [27/31]</div> <DIV class='slideCl1    ' id="s28"  >
<div class='navCl1'><a href="#s27"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s29"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Programming with Databases <span style="font-size:67%">(cont)</span></div></td><td align='right'></td></tr></table>
<p>
Example: find mature-age students &nbsp; <small>(e.g. 10000 students, 100 over 40)</small>
<p><pre>
query = "select * from Student";
results = dbQuery(db, query);
while (tuple = dbNext(results)) {
    if (tuple['age'] >= 40) {
        <span class='comment'>--  process mature-age student</span>
    }
}
</pre><p>
<br>
We transfer 10000 tuples from DB, 9500 are irrelevant
<p>
Cost = 1 query + 10000 tuple fetches
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [28/31]</div> <DIV class='slideCl1    ' id="s29"  >
<div class='navCl1'><a href="#s28"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s30"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Programming with Databases <span style="font-size:67%">(cont)</span></div></td><td align='right'></td></tr></table>
<p>
<br>
Should be implemented as:
<p><pre>
query = "select * from Student where age >= 40";
results = dbQuery(db, query);
while (tuple = dbNext(results)) {
    <span class='comment'>--  process mature-age student</span>
}
</pre><p>
<br>
Transfers only the 100 tuples that are needed.
<p>
Cost = 1 query + 100 tuple fetches
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [29/31]</div> <DIV class='slideCl1    ' id="s30"  >
<div class='navCl1'><a href="#s29"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>  <a href="#s31"><span class='nextArrowCl'> >> </span></a> </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Programming with Databases <span style="font-size:67%">(cont)</span></div></td><td align='right'></td></tr></table>
<p>
Example: find info about all marks for all students
<p><pre>
query1 = "select id,name from Student order by id";
res1 = dbQuery(db, query1);
while (tuple1 = dbNext(res1)) {
    query2 = "select course,mark from Marks"
             + " where student = " + tuple1['id'];
    res2 = dbQuery(db,query2);
    while (tuple2 = dbNext(res2)) {
        <span class='comment'>--  process student/course/mark info</span>
    }
}
</pre><p>
E.g. 10000 students, each with 8 marks, &rArr; run 10001 queries
<p>
Cost = 10001 queries + 80000 tuple fetches
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [30/31]</div> <DIV class='slideCl1    ' id="s31"  >
<div class='navCl1'><a href="#s30"><span class='prevArrowCl'> << </span></a>  <a href="#s0"><span class='upArrowCl'>&and;</span></a>   </div> <table width='100%' cellpadding='0'>
<tr valign='top'><td align='left'><div class='heading'>&#10070; Programming with Databases <span style="font-size:67%">(cont)</span></div></td><td align='right'></td></tr></table>
<p>
Should be implemented as:
<p><pre>
query = "select id,name,course,mark"
        + " from Student s join Marks m "
        + " on (s.id=m.student)"
        + " order by s.id"
results = dbQuery(db, query);
while (tuple = dbNext(results)) {
    <span class='comment'>--  process student/course/mark info</span>
}
</pre><p>
<br>
We invoke 1 query, and transfer same number of tuples.
<p>
Cost = 1 query + 80000 tuple fetches
</DIV>
<div class='slideNumCl2'>COMP3311 22T3 &#9826; Week 5 Tuesday Lecture &#9826; [31/31]</div><p><hr><p>
<span style='font-size:11px;color: grey;'>Produced: 14 Mar 2023</span>
 <script src='lib/prism.js'></script>   
 <script src='lib/sg.js'></script>   
</body>
</html>
